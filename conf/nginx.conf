server {
    listen 80;
    server_name localhost;

    location /qgisserver/ {
        proxy_pass http://qgis-server:80/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Script-Name /qgisserver;

        # Extract the project name from the URL
        if ($uri ~* "^/qgisserver/([^/]+)") {
            set $project $1;
            # Keep the original request but add the map parameter
            set $args "map=/etc/qgis/projects/$project.qgs&$args";
        }

        rewrite ^/qgisserver/(.*)$ /qgisserver/$1 break;
    }
}